---
- name: Common provisioning
  hosts: all
  become: true
  vars:
    k3s_control_plane_ip: "192.168.56.10"
    k3s_server_url: "https://192.168.56.10:6443"
    k3s_token: "ts-cni-dev-token"
    ts_cni_hostname: "ts-cni-dev-{{ inventory_hostname }}"
    tailscale_advertise_tags: "tag:tailscale-cni-dev"
  tasks:
    - name: Install Tailscale dependencies
      apt:
        name: [ca-certificates, curl]
        state: present
        update_cache: true

    - name: Add Tailscale apt signing key
      ansible.builtin.get_url:
        url: "https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_facts['distribution_release'] }}.noarmor.gpg"
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: "0644"
        force: true

    - name: Add Tailscale apt repository
      ansible.builtin.get_url:
        url: "https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_facts['distribution_release'] }}.tailscale-keyring.list"
        dest: /etc/apt/sources.list.d/tailscale.list
        mode: "0644"
        force: true

    - name: Install Tailscale
      apt:
        name: tailscale
        state: present
        update_cache: true

    # Don't start tailscaled on boot (Vagrant may still be configuring network)
    - name: Disable tailscaled from starting at boot
      systemd:
        name: tailscaled
        enabled: false
        daemon_reload: true

    - name: Start tailscaled (runs after provision has network and resolv.conf ready)
      systemd:
        name: tailscaled
        state: started

    - name: Print Tailscale join command
      debug:
        msg: |
          To join this machine to your tailnet, SSH in and run:
            sudo tailscale up --advertise-tags={{ tailscale_advertise_tags }}
          Then approve the node at https://login.tailscale.com/admin/machines

    - name: Set tailscale_ip from Tailscale interface (when joined to tailnet)
      set_fact:
        tailscale_ip: "{{ ansible_facts['tailscale0'].ipv4.address }}"
      when: ansible_facts['tailscale0'] is defined and ansible_facts['tailscale0'].ipv4 is defined

- name: Control plane specific
  hosts: control-plane
  become: true
  vars:
    k3s_token: "ts-cni-dev-token"
    k3s_cluster_cidr: "10.99.0.0/16"   # pod CIDR (unique to avoid clashes)
    k3s_service_cidr: "10.98.0.0/16"   # service CIDR
  tasks:
    - name: Install K3s server and configure for Tailscale
      when: tailscale_ip is defined and tailscale_ip | length > 0
      block:
        - name: Install K3s server (no CNI)
          shell: |
            curl -sfL https://get.k3s.io | sh -s - server \
              --flannel-backend=none \
              --cluster-cidr={{ k3s_cluster_cidr }} \
              --service-cidr={{ k3s_service_cidr }} \
              --disable=traefik,servicelb \
              --token={{ k3s_token }}
          args:
            creates: /usr/local/bin/k3s

        - name: Ensure k3s systemd drop-in directory exists
          file:
            path: /etc/systemd/system/k3s.service.d
            state: directory
            mode: "0755"

        - name: Create systemd drop-in for advertise-address and node-ip (Tailscale)
          copy:
            content: |
              [Service]
              ExecStart=
              ExecStart=/usr/local/bin/k3s server --flannel-backend=none --cluster-cidr={{ k3s_cluster_cidr }} --service-cidr={{ k3s_service_cidr }} --disable=traefik,servicelb --token={{ k3s_token }} --advertise-address={{ tailscale_ip }} --node-ip={{ tailscale_ip }}
            dest: /etc/systemd/system/k3s.service.d/advertise-address.conf
            mode: "0644"

        - name: Reload systemd and restart K3s to use Tailscale for API and node traffic
          systemd:
            name: k3s
            state: restarted
            daemon_reload: true

        - name: Wait for K3s API to be ready
          wait_for:
            port: 6443
            delay: 5
            timeout: 60

# Copy kubeconfig to host so kubectl can target the cluster via forwarded port 16443
- name: Export kubeconfig to host
  hosts: control-plane
  gather_facts: false
  vars:
    kubeconfig_host_port: "16443"
  tasks:
    - name: Export kubeconfig when K3s was installed
      block:
        - name: Read kubeconfig from control-plane
          slurp:
            src: /etc/rancher/k3s/k3s.yaml
          register: kubeconfig_slurp
          become: true

        - name: Write kubeconfig to host (testenv/kubeconfig)
          copy:
            content: "{{ (kubeconfig_slurp.content | b64decode) | regex_replace('https://[^:]+:6443', 'https://127.0.0.1:' ~ kubeconfig_host_port) }}"
            dest: "{{ playbook_dir }}/kubeconfig"
            mode: "0600"
          delegate_to: localhost
          run_once: true
      when: tailscale_ip is defined and tailscale_ip | length > 0

# Will need to run a deploy before this passes successfully
- name: Node specific
  hosts: node
  become: true
  vars:
    k3s_control_plane_ip: "192.168.56.10"
    k3s_server_url: "https://192.168.56.10:6443"
    k3s_token: "ts-cni-dev-token"
  tasks:
    - name: Install K3s agent and configure for Tailscale
      when: tailscale_ip is defined and tailscale_ip | length > 0
      block:
        - name: Wait for control-plane K3s API
          wait_for:
            host: "{{ k3s_control_plane_ip }}"
            port: 6443
            delay: 10
            timeout: 120

        - name: Install K3s agent
          shell: |
            curl -sfL https://get.k3s.io | sh -s - agent \
              --server={{ k3s_server_url }} \
              --token={{ k3s_token }}
          args:
            creates: /usr/local/bin/k3s

        - name: Ensure k3s-agent systemd drop-in directory exists
          file:
            path: /etc/systemd/system/k3s-agent.service.d
            state: directory
            mode: "0755"

        - name: Create systemd drop-in for node-ip (Tailscale)
          copy:
            content: |
              [Service]
              ExecStart=
              ExecStart=/usr/local/bin/k3s agent --server={{ k3s_server_url }} --token={{ k3s_token }} --node-ip={{ tailscale_ip }}
            dest: /etc/systemd/system/k3s-agent.service.d/node-ip.conf
            mode: "0644"

        - name: Reload systemd and restart K3s agent to use Tailscale for node traffic
          systemd:
            name: k3s-agent
            state: restarted
            daemon_reload: true

